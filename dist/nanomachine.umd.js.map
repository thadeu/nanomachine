{"version":3,"file":"nanomachine.umd.js","sources":["../src/utils.js","../src/machine-emitter.js","../src/nanomachine.js","../src/array-utils.js"],"sourcesContent":["export function uuidv4() {\n  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {\n    var r = (Math.random() * 16) | 0,\n      v = c == 'x' ? r : (r & 0x3) | 0x8\n\n    return v.toString(16)\n  })\n}\n\nexport function now() {\n  return new Date().toJSON()\n}\n\nexport function hasProp(object, prop) {\n  return Object.prototype.hasOwnProperty.call(object, prop)\n}\n","export function MachineEmitter() {\n  if (!(this instanceof MachineEmitter)) {\n    return new MachineEmitter()\n  }\n\n  this.events = {}\n}\n\nMachineEmitter.prototype.on = function(eventName, listener) {\n  if (eventName && listener) {\n    let listeners = this.events[eventName] || (this.events[eventName] = [])\n    listeners.push(listener)\n\n    return this\n  }\n\n  throw new Error('event name and listener is required')\n}\n\nMachineEmitter.prototype.once = function(event, listener) {\n  let s = this\n\n  this.on(event, once)\n\n  function once() {\n    listener.apply(s, arguments)\n    s.removeListener(event, once)\n  }\n}\n\nMachineEmitter.prototype.emit = function(event) {\n  var args = Array.prototype.slice.call(arguments, 1)\n  var eventThis = { event: event }\n  var listeners = []\n  var eventListeners = this.events[event]\n\n  if (eventListeners) {\n    Array.prototype.push.apply(listeners, eventListeners)\n\n    listeners.map(listener => {\n      listener.apply(eventThis, args)\n    })\n  }\n}\n\nMachineEmitter.prototype.removeListener = function(event, listener) {\n  let events = this.events\n  let evt = events[event]\n\n  if (listener) {\n    let idx = Array.prototype.indexOf.call(evt, listener)\n\n    if (idx !== -1) {\n      evt.splice(idx, 1)\n    }\n  } else {\n    events[event] = evt.slice()\n  }\n\n  return this\n}\n\nMachineEmitter.prototype.off = function(event, listener) {\n  if (listener) {\n    this.removeListener(event, listener)\n  } else {\n    this.events[event] = []\n  }\n}\n\nexport default MachineEmitter\n","import './array-utils'\nimport { now, uuidv4, hasProp } from './utils'\nimport MachineEmitter from './machine-emitter'\n\nexport function nanomachine(props) {\n  if (!(this instanceof nanomachine)) {\n    return new nanomachine(props)\n  }\n\n  this.initialProps = props\n  this.state = props.initial || 'idle'\n\n  this.transitions = props.transitions || []\n  this.history = new Map()\n  this.events = props.events || {}\n  this.logLevel = props.logLevel ? props.logLevel : 0\n  this.emitter = new MachineEmitter()\n\n  this.createOrUpdateTransitions(this.transitions)\n}\n\nnanomachine.prototype.logger = function() {\n  if (this.logLevel > 0) {\n    console.log.apply(null, Array.prototype.slice.call(arguments))\n  }\n}\n\nnanomachine.prototype.on = function(transitionName, cb) {\n  if (!Object.keys(this.events).includes(transitionName)) {\n    throw new Error(`cannot observer transition to ${transitionName}`)\n  }\n\n  return this.emitter.on(transitionName, cb)\n}\n\nnanomachine.prototype.createOrUpdateTransitions = function(transitions) {\n  return transitions.map(k => {\n    if (!nanomachine.prototype[k.name]) {\n      nanomachine.prototype[k.name] = function() {\n        return this.transitionTo(k.name)\n      }\n    }\n  })\n}\n\nnanomachine.prototype.reset = function() {\n  this.state = this.initialProps.initial\n  this.history.clear()\n\n  return this\n}\n\nnanomachine.prototype.can = function(transitionName) {\n  const prevState = this.state\n  const transition = this.transitions.flatFilter(f => f.name == transitionName)\n\n  if (transition.from === '*') {\n    return true\n  }\n\n  return transition.from.includes(prevState)\n}\n\nnanomachine.prototype.addHistory = function({ from, to }) {\n  this.logger('[nanomachine] @ history added ')\n  this.history.set(uuidv4(), { from, to, timestamp: now() })\n}\n\nnanomachine.prototype.transitionTo = function(transitionName) {\n  const prevState = this.state\n  const transition = this.transitions.flatFilter(f => f.name == transitionName)\n\n  if (!this.can(transitionName)) {\n    throw new TypeError(`cannot ${prevState} to ${transitionName}`)\n  } else if (hasProp(transition, 'if') && !transition.if()) {\n    throw new Error(`cannot ${prevState} to ${transitionName} because conditional failed`)\n  } else if (hasProp(transition, 'unless') && transition.unless()) {\n    throw new Error(`cannot ${prevState} to ${transitionName} because conditional failed`)\n  }\n\n  this.state = transition.to\n\n  const currentEvent = this.events[this.state]\n\n  if (currentEvent) {\n    this.emitter.emit(this.state, currentEvent)\n    this.addHistory({ from: prevState, to: this.state })\n    this.logger(`[nanomachine] @ fired ${this.state}`)\n  }\n}\n\nexport default nanomachine\n","if (!Array.prototype.flatFilter) {\n  Array.prototype.flatFilter = function(cb) {\n    return this.filter(cb).reduce(a => a)\n  }\n}\n"],"names":["hasProp","object","prop","Object","prototype","hasOwnProperty","call","MachineEmitter","this","events","nanomachine","props","initialProps","state","initial","transitions","history","Map","logLevel","emitter","createOrUpdateTransitions","Array","flatFilter","cb","filter","reduce","a","on","eventName","listener","push","Error","once","event","s","apply","arguments","removeListener","emit","args","slice","eventThis","listeners","eventListeners","map","evt","idx","indexOf","splice","off","logger","console","log","transitionName","keys","includes","k","name","transitionTo","reset","clear","can","prevState","transition","f","from","addHistory","ref","set","replace","c","r","Math","random","toString","to","timestamp","Date","toJSON","TypeError","if","unless","currentEvent"],"mappings":"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"}